# Flujo de Registro y Verificación de Email

- Registro: Después de POST /usuario, mostrar mensaje para verificar email. No permitir login inmediato.
- Verificación: El enlace en el email apunta a una página frontend que llama GET /auth/verify-email?token=xyz. Manejar redirección post-verificación.
- Reenvío: Proporcionar opción en UI para reenviar email si no llega.
- Login: Si falla por email no verificado, mostrar opción para verificar o reenviar.
- Errores: Manejar respuestas de error (401 para login sin verificación, 400 para token inválido).
- Emails: Los emails se envían desde soporte-dev@tuchambita.com (dev) o soporte@tuchambita.com (prod).

### Diagrama de Secuencia

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant AC as AuthController
    participant UC as UsuarioController
    participant AS as AuthService
    participant US as UsuarioService
    participant EVS as EmailVerificationService
    participant R as UsuarioRepository

    %% Registro
    U->>F: Solicita registro con email
    F->>UC: POST /usuario (datos de registro)
    UC->>US: registrar(requestBody)
    US->>R: guardar usuario (emailVerified=false)
    R-->>US: usuario guardado
    US->>EVS: generar token y enviar email desde soporte@tuchambita.com
    EVS-->>US: email enviado
    US-->>UC: UsuarioRegisteredResponse
    UC-->>F: Respuesta de registro + mensaje "Verifica tu email"
    F-->>U: Mostrar pantalla de verificación o mensaje

    %% Verificación de Email
    U->>F: Recibe email y hace clic en enlace
    F->>AC: GET /auth/verify-email?token=xyz
    AC->>EVS: verificarEmailToken(token)
    EVS->>R: actualizar emailVerified=true
    R-->>EVS: actualizado
    EVS-->>AC: confirmación
    AC-->>F: Redirigir a login o página de éxito
    F-->>U: Confirmación de verificación

    %% Reenvío de Verificación (opcional)
    U->>F: Solicita reenvío si no recibió email
    F->>AC: POST /auth/resend-verification (body: email)
    AC->>EVS: resendVerificationEmail(email)
    EVS->>EVS: generar nuevo token y enviar email
    EVS-->>AC: email reenviado
    AC-->>F: Mensaje de éxito
    F-->>U: Notificación de reenvío

    %% Login con Verificación
    U->>F: Intenta login
    F->>AC: POST /auth/login (credenciales)
    AC->>AS: getTokenLogin(credenciales)
    AS->>R: obtener usuario por email
    R-->>AS: UsuarioPersonalInfo
    AS->>AS: Verificar password y emailVerified
    alt emailVerified == true
        AS->>AS: Generar token JWT
        AS-->>AC: token
        AC-->>F: Respuesta con Authorization header
        F-->>U: Acceso concedido
    else emailVerified == false
        AS-->>AC: Excepción (email no verificado)
        AC-->>F: Error 401 con mensaje "Verifica tu email"
        F-->>U: Redirigir a verificación o mostrar error
    end

```
